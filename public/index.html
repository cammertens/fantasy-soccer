<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fantasy Soccer League</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --green: #1a7a3c;
    --green-light: #2da653;
    --green-dark: #0f4a24;
    --gold: #f5c842;
    --gold-dim: #c9a020;
    --red: #c0392b;
    --blue: #1a4f8a;
    --white: #f5f5f0;
    --offwhite: #edeee8;
    --gray: #8a8a82;
    --gray-light: #d4d4cc;
    --dark: #111410;
    --card-bg: #1c1f1a;
    --card-border: #2a2e27;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0e1210;
    color: var(--white);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
  }

  /* NAV */
  nav {
    background: var(--dark);
    border-bottom: 2px solid var(--green);
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 56px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .nav-logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 2px;
    color: var(--gold);
  }

  .nav-tabs {
    display: flex;
    gap: 0;
    height: 100%;
  }

  .nav-tab {
    padding: 0 20px;
    background: none;
    border: none;
    color: var(--gray);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    height: 100%;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
  }

  .nav-tab:hover { color: var(--white); }
  .nav-tab.active { color: var(--gold); border-bottom-color: var(--gold); }
  .nav-tab.hidden { display: none; }

  .nav-badge {
    background: var(--green);
    color: var(--white);
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 10px;
    margin-left: 6px;
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: var(--gray);
  }

  .admin-badge {
    background: rgba(245,200,66,0.15);
    border: 1px solid rgba(245,200,66,0.3);
    color: var(--gold);
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  /* PAGES */
  .page { display: none; }
  .page.active { display: block; }

  /* ===== LANDING / JOIN PAGE ===== */
  .landing {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - 56px);
    padding: 24px;
  }

  .landing-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    padding: 40px;
    max-width: 480px;
    width: 100%;
    text-align: center;
  }

  .landing-logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    letter-spacing: 4px;
    color: var(--gold);
    margin-bottom: 8px;
  }

  .landing-sub {
    color: var(--gray);
    font-size: 14px;
    margin-bottom: 32px;
  }

  .landing-divider {
    border: none;
    border-top: 1px solid var(--card-border);
    margin: 24px 0;
  }

  .section-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 2px;
    color: var(--white);
    margin-bottom: 16px;
    text-align: left;
  }

  .form-group {
    margin-bottom: 14px;
    text-align: left;
  }

  .form-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--gray);
    margin-bottom: 6px;
  }

  .form-input {
    width: 100%;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--card-border);
    color: var(--white);
    padding: 10px 14px;
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  .form-input:focus { border-color: var(--green-light); }
  .form-input::placeholder { color: var(--gray); }

  .form-select {
    width: 100%;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--card-border);
    color: var(--white);
    padding: 10px 14px;
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    outline: none;
    cursor: pointer;
  }

  .btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--green);
    color: var(--white);
  }
  .btn-primary:hover { background: var(--green-light); }

  .btn-gold {
    background: var(--gold);
    color: var(--dark);
  }
  .btn-gold:hover { background: var(--gold-dim); }

  .btn-sm {
    width: auto;
    padding: 8px 16px;
    font-size: 12px;
  }

  .btn-outline {
    background: transparent;
    color: var(--gray);
    border: 1px solid var(--card-border);
  }
  .btn-outline:hover { color: var(--white); border-color: var(--gray); }

  .error-msg {
    background: rgba(192,57,43,0.15);
    border: 1px solid rgba(192,57,43,0.3);
    color: #f87171;
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 13px;
    margin-top: 12px;
    display: none;
  }

  .success-msg {
    background: rgba(26,122,60,0.15);
    border: 1px solid rgba(26,122,60,0.3);
    color: #4ade80;
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 13px;
    margin-top: 12px;
    display: none;
  }

  /* ===== ADMIN SETUP PAGE ===== */
  .admin-setup {
    max-width: 700px;
    margin: 0 auto;
    padding: 24px;
  }

  .admin-page-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    letter-spacing: 3px;
    color: var(--gold);
    margin-bottom: 4px;
  }

  .admin-page-sub {
    color: var(--gray);
    font-size: 13px;
    margin-bottom: 24px;
  }

  .admin-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 16px;
  }

  .invite-links-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 16px;
  }

  .invite-link-row {
    display: grid;
    grid-template-columns: 80px 1fr auto;
    gap: 10px;
    align-items: center;
    padding: 10px 14px;
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
    border: 1px solid var(--card-border);
  }

  .invite-slot-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--gray);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .invite-link-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--green-light);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .invite-status {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: 600;
    white-space: nowrap;
  }

  .status-waiting {
    background: rgba(138,138,130,0.2);
    color: var(--gray);
  }

  .status-joined {
    background: rgba(26,122,60,0.2);
    color: #4ade80;
  }

  .draft-order-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 12px;
  }

  .draft-order-item {
    display: grid;
    grid-template-columns: 32px 1fr auto;
    align-items: center;
    padding: 8px 14px;
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
    border: 1px solid var(--card-border);
    gap: 10px;
  }

  .order-num {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--gold);
    font-weight: 600;
  }

  .order-name { font-size: 13px; font-weight: 500; }

  /* ===== HOME PAGE ===== */
  .home-layout {
    display: grid;
    grid-template-columns: 1fr 240px;
    gap: 16px;
    padding: 16px;
    max-width: 1600px;
    margin: 0 auto;
  }

  .standings-sidebar {
    position: sticky;
    top: 72px;
    height: fit-content;
  }

  .sidebar-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 8px;
    overflow: hidden;
  }

  .sidebar-header {
    background: var(--green-dark);
    padding: 12px 16px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 2px;
    color: var(--gold);
  }

  .standings-row {
    display: grid;
    grid-template-columns: 24px 1fr auto;
    align-items: center;
    padding: 9px 14px;
    border-bottom: 1px solid var(--card-border);
    font-size: 13px;
    gap: 8px;
  }

  .standings-row:last-child { border-bottom: none; }

  .rank { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--gray); text-align: center; }
  .rank.gold { color: var(--gold); font-weight: 600; }
  .rank.silver { color: #aaa; font-weight: 600; }
  .rank.bronze { color: #cd7f32; font-weight: 600; }

  .standings-name { font-weight: 500; }
  .standings-pts { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; color: var(--gold); }

  .undrafted-row { background: rgba(90,90,90,0.1); }
  .undrafted-row .standings-name { color: var(--gray); font-style: italic; }
  .undrafted-row .standings-pts { color: var(--gray); }

  .managers-column { display: flex; flex-direction: column; gap: 12px; }

  .manager-block {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 8px;
    overflow: hidden;
  }

  .manager-header {
    padding: 10px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .manager-name-cell { font-family: 'Bebas Neue', sans-serif; font-size: 16px; letter-spacing: 1px; }
  .manager-team-cell { color: var(--gray); font-size: 12px; }

  .col-header {
    display: grid;
    padding: 6px 14px;
    background: rgba(0,0,0,0.3);
    border-bottom: 1px solid var(--card-border);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--gray);
  }

  .player-row {
    display: grid;
    padding: 7px 14px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    font-size: 13px;
    align-items: center;
  }

  .player-row:last-child { border-bottom: none; }
  .player-row.defense-row { background: rgba(26,79,138,0.12); border-top: 1px solid rgba(26,79,138,0.3); }

  .player-name { font-weight: 500; }
  .player-country { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--gray); font-weight: 600; }

  .md-cell { text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--gray-light); }
  .md-cell.pos { color: #4ade80; }
  .md-cell.neg { color: #f87171; }
  .md-cell.zero { color: var(--gray); }

  .total-cell {
    text-align: right;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    background: rgba(245,200,66,0.12);
    padding: 3px 8px;
    border-radius: 4px;
    color: var(--gold);
  }

  .manager-total-row {
    display: grid;
    grid-template-columns: 1fr auto;
    padding: 8px 14px;
    background: rgba(0,0,0,0.25);
    border-top: 1px solid var(--card-border);
  }

  .manager-total-label { color: var(--gray); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; }
  .manager-total-pts { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--gold); font-size: 15px; }

  /* ===== DRAFT PAGE ===== */
  .on-clock-banner {
    background: linear-gradient(90deg, rgba(245,200,66,0.15), transparent);
    border: 1px solid rgba(245,200,66,0.3);
    border-radius: 6px;
    padding: 10px 16px;
    margin: 12px 16px 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .clock-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--gold);
    animation: blink 1.2s infinite;
    flex-shrink: 0;
  }

  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }
  @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(245,200,66,0.3)} 50%{box-shadow:0 0 0 4px rgba(245,200,66,0.1)} }

  .clock-text { font-size: 13px; }
  .clock-text strong { color: var(--gold); }

  .draft-header-bar {
    background: var(--dark);
    border-bottom: 1px solid var(--card-border);
    padding: 12px 16px;
    position: sticky;
    top: 56px;
    z-index: 90;
  }

  .draft-header-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
    letter-spacing: 2px;
    color: var(--gray);
    margin-bottom: 8px;
  }

  .draft-snake-scroll {
    display: flex;
    gap: 4px;
    overflow-x: auto;
    padding-bottom: 4px;
    scrollbar-width: thin;
    scrollbar-color: var(--green) transparent;
  }

  .snake-pick {
    flex-shrink: 0;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 5px;
    padding: 5px 10px;
    min-width: 110px;
    font-size: 11px;
  }

  .snake-pick.completed { border-color: var(--green-dark); background: rgba(26,122,60,0.1); }
  .snake-pick.current { border-color: var(--gold); background: rgba(245,200,66,0.1); animation: pulse 2s infinite; }

  .snake-pick-num { font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--gray); margin-bottom: 2px; }
  .snake-pick-manager { font-size: 11px; font-weight: 600; color: var(--white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .snake-pick.completed .snake-pick-manager { color: var(--gray); }
  .snake-pick.current .snake-pick-manager { color: var(--gold); }
  .snake-pick-player { font-size: 10px; color: var(--green-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }

  .draft-body {
    display: grid;
    grid-template-columns: 280px 1fr 280px;
    height: calc(100vh - 56px - 110px);
    overflow: hidden;
  }

  .draft-col {
    border-right: 1px solid var(--card-border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .draft-col:last-child { border-right: none; }

  .draft-col-header {
    background: var(--green-dark);
    padding: 10px 14px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 2px;
    color: var(--gold);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .draft-col-body {
    flex: 1;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--green) transparent;
  }

  .team-selector {
    padding: 10px 14px;
    background: rgba(0,0,0,0.2);
    border-bottom: 1px solid var(--card-border);
    flex-shrink: 0;
  }

  .team-selector select {
    width: 100%;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    color: var(--white);
    padding: 7px 10px;
    border-radius: 5px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    outline: none;
  }

  .roster-slot {
    display: grid;
    grid-template-columns: 1fr auto;
    padding: 10px 14px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    align-items: center;
    gap: 8px;
  }

  .roster-slot.defense { background: rgba(26,79,138,0.12); }
  .slot-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: var(--gray); font-weight: 600; margin-bottom: 2px; }
  .slot-name { font-size: 13px; font-weight: 500; }
  .slot-name.empty { color: var(--gray); font-style: italic; font-size: 12px; }
  .slot-country { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--gray); }
  .slot-pick-info { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--gray); text-align: right; }

  .pool-controls {
    padding: 10px 14px;
    background: rgba(0,0,0,0.2);
    border-bottom: 1px solid var(--card-border);
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex-shrink: 0;
  }

  .pool-search {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    color: var(--white);
    padding: 8px 12px;
    border-radius: 5px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    outline: none;
    width: 100%;
    transition: border-color 0.2s;
  }

  .pool-search:focus { border-color: var(--green-light); }
  .pool-search::placeholder { color: var(--gray); }

  .pool-filters { display: flex; gap: 6px; }

  .pool-filter {
    flex: 1;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    color: var(--white);
    padding: 6px 8px;
    border-radius: 5px;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    cursor: pointer;
    outline: none;
  }

  .pool-player {
    display: grid;
    grid-template-columns: 1fr auto;
    padding: 10px 14px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    cursor: pointer;
    transition: background 0.15s;
    align-items: center;
  }

  .pool-player:hover { background: rgba(26,122,60,0.15); }
  .pool-player.selected { background: rgba(245,200,66,0.1); border-left: 3px solid var(--gold); }
  .pool-player.not-your-turn { cursor: default; opacity: 0.6; }

  .pool-player-name { font-size: 13px; font-weight: 500; margin-bottom: 2px; }
  .pool-player-meta { display: flex; gap: 8px; align-items: center; }

  .pool-player-country { font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 600; color: var(--gray); }

  .pool-player-pos {
    font-size: 10px; padding: 1px 6px; border-radius: 3px;
    font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
  }

  .pos-fw { background: rgba(192,57,43,0.3); color: #f87171; }
  .pos-mf { background: rgba(26,122,60,0.3); color: #4ade80; }
  .pos-df { background: rgba(26,79,138,0.3); color: #60a5fa; }
  .pos-gk { background: rgba(245,200,66,0.2); color: var(--gold); }
  .pos-team { background: rgba(111,66,193,0.3); color: #a78bfa; }

  .pick-confirm-bar {
    padding: 10px 14px;
    background: rgba(245,200,66,0.08);
    border-top: 1px solid rgba(245,200,66,0.2);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    flex-shrink: 0;
  }

  .pick-confirm-bar.hidden { display: none; }
  .pick-confirm-name { font-size: 13px; font-weight: 600; color: var(--gold); }
  .pick-confirm-sub { font-size: 11px; color: var(--gray); }

  .confirm-btn {
    background: var(--green);
    color: var(--white);
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: background 0.15s;
  }

  .confirm-btn:hover { background: var(--green-light); }

  .cancel-btn {
    background: transparent;
    color: var(--gray);
    border: 1px solid var(--card-border);
    padding: 8px 12px;
    border-radius: 5px;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    cursor: pointer;
  }

  .result-item {
    display: grid;
    grid-template-columns: 48px 1fr;
    padding: 10px 14px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    gap: 10px;
    align-items: center;
  }

  .result-pick-num { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--gray); text-align: center; }
  .result-round { font-size: 9px; color: var(--green-light); text-transform: uppercase; letter-spacing: 0.5px; }
  .result-player { font-size: 13px; font-weight: 500; margin-bottom: 1px; }
  .result-manager { font-size: 11px; color: var(--gray); }
  .result-country { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--gray); margin-left: 6px; }

  /* ===== PLAYER POOL PAGE ===== */
  .pool-page { padding: 16px; max-width: 1400px; margin: 0 auto; }

  .pool-page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .page-title { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 3px; color: var(--gold); }

  .pool-page-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

  .pool-page-search {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    color: var(--white);
    padding: 8px 14px;
    border-radius: 5px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    outline: none;
    width: 220px;
  }

  .pool-page-filter {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    color: var(--white);
    padding: 8px 12px;
    border-radius: 5px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    outline: none;
  }

  .pool-table { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 8px; overflow: hidden; }

  .pool-table-header {
    display: grid;
    grid-template-columns: 1fr 70px 60px 50px 50px 50px 50px 50px 50px 50px 50px 100px;
    padding: 10px 16px;
    background: var(--green-dark);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--gray-light);
  }

  .pool-table-header span { text-align: center; }
  .pool-table-header span:first-child { text-align: left; }
  .pool-table-header span:last-child { text-align: right; }

  .pool-table-row {
    display: grid;
    grid-template-columns: 1fr 70px 60px 50px 50px 50px 50px 50px 50px 50px 50px 100px;
    padding: 9px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    font-size: 13px;
    align-items: center;
    transition: background 0.1s;
  }

  .pool-table-row:hover { background: rgba(255,255,255,0.03); }
  .pool-table-row.drafted { opacity: 0.35; }
  .pool-table-row span { text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--gray-light); }
  .pool-table-row span:first-child { text-align: left; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; color: var(--white); }
  .pool-table-row span:last-child { text-align: right; font-weight: 700; color: var(--gold); font-family: 'DM Sans', sans-serif; font-size: 12px; }

  .tag-drafted {
    font-size: 9px;
    background: rgba(192,57,43,0.3);
    color: #f87171;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 600;
    text-transform: uppercase;
    margin-left: 6px;
  }

  /* Loading & empty states */
  .loading-state {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 48px;
    color: var(--gray);
    font-size: 14px;
    gap: 12px;
  }

  .spinner {
    width: 20px; height: 20px;
    border: 2px solid var(--card-border);
    border-top-color: var(--green-light);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-state { padding: 32px; text-align: center; color: var(--gray); font-size: 13px; }

  /* Admin manual stat entry */
  .manual-stat-form {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 10px;
    align-items: end;
    margin-top: 12px;
  }

  .stat-log-item {
    display: grid;
    grid-template-columns: 1fr auto auto;
    padding: 8px 14px;
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
    border: 1px solid var(--card-border);
    margin-bottom: 6px;
    font-size: 13px;
    gap: 10px;
    align-items: center;
  }

  .stat-pts { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--gold); }

  /* Manager colors */
  .mc-0 { border-left-color: #1a4f8a !important; background: linear-gradient(90deg, rgba(26,79,138,0.15), transparent) !important; }
  .mc-1 { border-left-color: #7b2d8b !important; background: linear-gradient(90deg, rgba(123,45,139,0.15), transparent) !important; }
  .mc-2 { border-left-color: #b05a12 !important; background: linear-gradient(90deg, rgba(176,90,18,0.15), transparent) !important; }
  .mc-3 { border-left-color: #8a1a1a !important; background: linear-gradient(90deg, rgba(138,26,26,0.15), transparent) !important; }
  .mc-4 { border-left-color: #1a7a3c !important; background: linear-gradient(90deg, rgba(26,122,60,0.15), transparent) !important; }
  .mc-5 { border-left-color: #6a6a00 !important; background: linear-gradient(90deg, rgba(106,106,0,0.15), transparent) !important; }
  .mc-6 { border-left-color: #1a5a5a !important; background: linear-gradient(90deg, rgba(26,90,90,0.15), transparent) !important; }
  .mc-7 { border-left-color: #5a1a6a !important; background: linear-gradient(90deg, rgba(90,26,106,0.15), transparent) !important; }

  /* Mobile */
  @media (max-width: 768px) {
    .home-layout { grid-template-columns: 1fr; padding: 10px; }
    .standings-sidebar { position: static; order: -1; }
    .draft-body { grid-template-columns: 1fr; height: auto; }
    .draft-col { border-right: none; border-bottom: 1px solid var(--card-border); max-height: 400px; }
    .nav-tab { padding: 0 10px; font-size: 11px; }
    .pool-table-header, .pool-table-row { grid-template-columns: 1fr 60px 50px 50px 50px 80px; }
    .pool-table-header span:nth-child(n+5):nth-child(-n+11),
    .pool-table-row span:nth-child(n+5):nth-child(-n+11) { display: none; }
    .manual-stat-form { grid-template-columns: 1fr 1fr; }
    .landing-card { padding: 24px; }
  }
</style>
</head>
<body>

<nav>
  <div class="nav-logo" onclick="goHome()" style="cursor:pointer">⚽ Fantasy Soccer</div>
  <div class="nav-tabs">
    <button class="nav-tab hidden" id="tab-home" onclick="showPage('home', this)">Standings</button>
    <button class="nav-tab hidden" id="tab-draft" onclick="showPage('draft', this)">Draft Room</button>
    <button class="nav-tab hidden" id="tab-pool" onclick="showPage('pool', this)">Player Pool</button>
    <button class="nav-tab hidden" id="tab-admin" onclick="showPage('admin', this)">Admin ⚙</button>
  </div>
  <div class="nav-right">
    <span id="nav-league-name"></span>
    <span id="nav-admin-badge" class="admin-badge" style="display:none">ADMIN</span>
  </div>
</nav>

<div class="error-msg" id="global-error" style="display:none;max-width:1100px;margin:10px auto 0 auto"></div>

<!-- ===== LANDING PAGE ===== -->
<div id="page-landing" class="page active">
  <div class="landing">
    <div class="landing-card">
      <div class="landing-logo">⚽ Fantasy Soccer</div>
      <div class="landing-sub">American-style tournament fantasy league</div>

      <hr class="landing-divider">

      <!-- Admin: Create League -->
      <div class="section-title">Create a League</div>
      <div class="form-group">
        <label class="form-label">League Name</label>
        <input class="form-input" id="create-league-name" placeholder="e.g. Tape Room Fantasy 2026" />
      </div>
      <div class="form-group">
        <label class="form-label">Number of Managers</label>
        <select class="form-select" id="create-manager-count">
          <option value="8">8 Managers</option>
          <option value="10">10 Managers</option>
          <option value="12" selected>12 Managers</option>
          <option value="14">14 Managers</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Competition</label>
        <select class="form-select" id="create-competition">
          <option value="2|2025">UEFA Champions League 2025/26</option>
          <option value="1|2026">FIFA World Cup 2026</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Your Name (Commissioner)</label>
        <input class="form-input" id="create-admin-name" placeholder="e.g. Cam" />
      </div>
      <button class="btn btn-gold" onclick="createLeague()">Create League</button>
      <div class="error-msg" id="create-error"></div>
      <div class="success-msg" id="create-success"></div>

      <hr class="landing-divider">

      <div id="my-leagues-section" style="display:none">
        <div class="section-title">Your Leagues</div>
        <div id="my-leagues-list" style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px"></div>
        <hr class="landing-divider">
      </div>

      <!-- Join or rejoin -->
      <div class="section-title">Join or Rejoin</div>
      <div class="form-group">
        <label class="form-label">Your Invite / Admin Link</label>
        <input class="form-input" id="join-token" placeholder="Paste your link or token here" />
      </div>
      <button class="btn btn-primary" onclick="joinWithToken()">Enter League</button>
      <div class="error-msg" id="join-error"></div>
    </div>
  </div>
</div>

<!-- ===== JOIN PAGE (manager setup) ===== -->
<div id="page-join" class="page">
  <div class="landing">
    <div class="landing-card">
      <div class="landing-logo">⚽</div>
      <div id="join-league-name" style="font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:var(--gold);margin-bottom:8px"></div>
      <div class="landing-sub" id="join-league-sub">You've been invited to join the league</div>
      <hr class="landing-divider">
      <div class="section-title">Set Up Your Team</div>
      <div class="form-group">
        <label class="form-label">Your Name</label>
        <input class="form-input" id="setup-manager-name" placeholder="e.g. Alex" />
      </div>
      <div class="form-group">
        <label class="form-label">Team Name</label>
        <input class="form-input" id="setup-team-name" placeholder="e.g. Messi Believers" />
      </div>
      <button class="btn btn-primary" onclick="completeJoin()">Join League</button>
      <div class="error-msg" id="setup-error"></div>
    </div>
  </div>
</div>

<!-- ===== HOME PAGE ===== -->
<div id="page-home" class="page">
  <div class="home-layout">
    <div class="managers-column" id="managers-column">
      <div class="loading-state"><div class="spinner"></div> Loading rosters...</div>
    </div>
    <div class="standings-sidebar">
      <div class="sidebar-card">
        <div class="sidebar-header">Standings</div>
        <div id="standings-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== DRAFT PAGE ===== -->
<div id="page-draft" class="page">
  <div class="on-clock-banner" id="clock-banner">
    <div class="clock-dot"></div>
    <div class="clock-text">On the clock: <strong id="on-clock-name">—</strong> — Round <strong id="on-clock-round">—</strong>, Pick <strong id="on-clock-overall">—</strong></div>
  </div>
  <div class="draft-header-bar">
    <div class="draft-header-title">Draft Order — Snake</div>
    <div class="draft-snake-scroll" id="snake-scroll"></div>
  </div>
  <div class="draft-body">
    <div class="draft-col">
      <div class="draft-col-header">Team Roster</div>
      <div class="team-selector">
        <select id="roster-selector" onchange="renderRoster()"></select>
      </div>
      <div class="draft-col-body" id="roster-display"></div>
    </div>
    <div class="draft-col">
      <div class="draft-col-header">
        Available Players
        <span style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--gray)" id="available-count"></span>
      </div>
      <div class="pool-controls">
        <input class="pool-search" type="text" placeholder="Search players..." id="draft-search" oninput="filterDraftPool()">
        <div class="pool-filters">
          <select class="pool-filter" id="draft-pos-filter" onchange="filterDraftPool()">
            <option value="">All Positions</option>
            <option value="FW">Forwards</option>
            <option value="MF">Midfielders</option>
            <option value="DF">Defenders</option>
            <option value="GK">Goalkeepers</option>
            <option value="TEAM">Team Defense</option>
          </select>
          <select class="pool-filter" id="draft-country-filter" onchange="filterDraftPool()">
            <option value="">All Countries</option>
          </select>
        </div>
      </div>
      <div class="draft-col-body" id="draft-pool">
        <div class="loading-state"><div class="spinner"></div> Loading players...</div>
      </div>
      <div class="pick-confirm-bar hidden" id="confirm-bar">
        <div>
          <div class="pick-confirm-name" id="confirm-player-name"></div>
          <div class="pick-confirm-sub" id="confirm-player-sub"></div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="cancel-btn" onclick="clearSelection()">Cancel</button>
          <button class="confirm-btn" onclick="confirmPick()">Draft</button>
        </div>
      </div>
    </div>
    <div class="draft-col">
      <div class="draft-col-header">Draft Results</div>
      <div class="draft-col-body" id="draft-results"></div>
    </div>
  </div>
</div>

<!-- ===== PLAYER POOL PAGE ===== -->
<div id="page-pool" class="page pool-page">
  <div class="pool-page-header">
    <div class="page-title">Player Pool</div>
    <div class="pool-page-controls">
      <input class="pool-page-search" type="text" placeholder="Search..." id="pool-search" oninput="filterPoolPage()">
      <select class="pool-page-filter" id="pool-pos-filter" onchange="filterPoolPage()">
        <option value="">All Positions</option>
        <option value="FW">Forwards</option>
        <option value="MF">Midfielders</option>
        <option value="DF">Defenders</option>
        <option value="GK">Goalkeepers</option>
        <option value="TEAM">Team Defense</option>
      </select>
      <select class="pool-page-filter" id="pool-country-filter" onchange="filterPoolPage()">
        <option value="">All Countries</option>
      </select>
      <select class="pool-page-filter" id="pool-status-filter" onchange="filterPoolPage()">
        <option value="">All Players</option>
        <option value="available">Available</option>
        <option value="drafted">Drafted</option>
      </select>
    </div>
  </div>
  <div class="pool-table">
    <div class="pool-table-header">
      <span>Player</span><span>Country</span><span>Pos</span>
      <span>GS1</span><span>GS2</span><span>GS3</span>
      <span>R32</span><span>R16</span><span>QF</span><span>SF</span><span>F</span>
      <span>Total / Status</span>
    </div>
    <div id="pool-table-body"><div class="loading-state"><div class="spinner"></div> Loading...</div></div>
  </div>
</div>

<!-- ===== ADMIN PAGE ===== -->
<div id="page-admin" class="page">
  <div class="admin-setup">
    <div class="admin-page-title">Admin Panel</div>
    <div class="admin-page-sub" id="admin-league-info"></div>

    <!-- Invite Links -->
    <div class="admin-card">
      <div class="section-title">Invite Links</div>
      <p style="font-size:13px;color:var(--gray);margin-bottom:4px">Send these links to your managers. Each link is unique to one slot.</p>
      <div class="invite-links-grid" id="invite-links-grid"></div>
    </div>

    <!-- Draft Order -->
    <div class="admin-card">
      <div class="section-title">Draft Order</div>
      <p style="font-size:13px;color:var(--gray);margin-bottom:12px">Set the Round 1 order. Snake draft reverses each round automatically.</p>
      <div class="draft-order-list" id="draft-order-list"></div>
      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn btn-primary btn-sm" onclick="randomizeDraftOrder()">Randomize</button>
        <button class="btn btn-gold btn-sm" onclick="saveDraftOrder()">Save Order</button>
      </div>
    </div>

    <!-- Draft Controls -->
    <div class="admin-card">
      <div class="section-title">Draft Controls</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="toggleDraft(true)">Open Draft</button>
        <button class="btn btn-outline btn-sm" onclick="toggleDraft(false)">Close Draft</button>
        <button class="btn btn-outline btn-sm" onclick="undoLastPick()">Undo Last Pick</button>
      </div>
      <div class="success-msg" id="draft-control-msg" style="margin-top:10px"></div>
    </div>

    <!-- Manual Stats -->
    <div class="admin-card">
      <div class="section-title">Manual Stat Entry</div>
      <p style="font-size:13px;color:var(--gray);margin-bottom:4px">Add penalty drawn events or correct any stat.</p>
      <div class="manual-stat-form">
        <div class="form-group" style="margin:0">
          <label class="form-label">Player</label>
          <select class="form-select" id="manual-player" style="font-size:12px;padding:8px 10px"></select>
        </div>
        <div class="form-group" style="margin:0">
          <label class="form-label">Stage</label>
          <select class="form-select" id="manual-stage" style="font-size:12px;padding:8px 10px">
            <option>GS1</option><option>GS2</option><option>GS3</option>
            <option>R32</option><option>R16</option><option>QF</option>
            <option>SF</option><option>F</option>
          </select>
        </div>
        <div class="form-group" style="margin:0">
          <label class="form-label">Stat Type</label>
          <select class="form-select" id="manual-stat-type" style="font-size:12px;padding:8px 10px">
            <option value="penalty_drawn">Penalty Drawn (+1)</option>
            <option value="goal">Goal (+3)</option>
            <option value="pk_goal">PK Goal (+2)</option>
            <option value="assist">Assist (+1)</option>
            <option value="pk_miss">PK Miss (-1)</option>
            <option value="red_card">Red Card (-2)</option>
          </select>
        </div>
        <button class="btn btn-gold btn-sm" style="margin-bottom:0" onclick="addManualStat()">Add</button>
      </div>
      <div style="margin-top:12px" id="manual-stat-log"></div>
    </div>

    <!-- Admin token display -->
    <div class="admin-card" style="border-color:rgba(245,200,66,0.2)">
      <div class="section-title">Your Admin Link</div>
      <p style="font-size:13px;color:var(--gray);margin-bottom:8px">Save this — it's how you get back to this admin panel.</p>
      <div style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--gold);word-break:break-all;padding:10px;background:rgba(0,0,0,0.3);border-radius:6px" id="admin-link-display"></div>
    </div>
  </div>
</div>

<script>
const API = window.location.origin;
const STAGES = ['GS1','GS2','GS3','R32','R16','QF','SF','F'];
const ROSTER_SLOTS = 8; // 7 offense + 1 defense

// =============================================
// APP STATE
// =============================================
let state = {
  leagueId: null,
  adminToken: null,
  managerId: null,
  managerName: null,
  league: null,
  players: [],
  teams: [],
  selectedPlayer: null,
  manualStats: [],
  draftOrder: [],
  isAdmin: false
};

// Load from localStorage
function loadState() {
  try {
    localStorage.removeItem('fantasyLeagueState');
    const saved = localStorage.getItem('fsl_state');
    if (saved) Object.assign(state, JSON.parse(saved));
  } catch(e) {}
}

function saveState() {
    localStorage.setItem('fsl_state', JSON.stringify({
    leagueId: state.leagueId,
    adminToken: state.adminToken,
    managerId: state.managerId,
    managerName: state.managerName,
    isAdmin: state.isAdmin
  }));
}

// =============================================
// LANDING / AUTH
// =============================================
async function createLeague() {
  const name = document.getElementById('create-league-name').value.trim();
  const managerCount = parseInt(document.getElementById('create-manager-count').value);
  const adminName = document.getElementById('create-admin-name').value.trim();
  const competitionVal = document.getElementById('create-competition').value;
  const [leagueId, season] = competitionVal.split('|');

  const competition = {
    leagueId: parseInt(leagueId),
    season: parseInt(season),
    name: document.getElementById('create-competition').selectedOptions[0].text
  };

  showError('create-error', '');

  if (!name) return showError('create-error', 'Please enter a league name.');

  try {
    const res = await fetch(`${API}/api/leagues`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, managerCount, competition, adminName })
    });
    const data = await res.json();
    if (!res.ok) return showError('create-error', data.error);

    state.leagueId = String(data.leagueId);
    state.adminToken = data.adminToken;
    state.managerName = adminName;
    state.isAdmin = true;
    state.managerId = data.adminManagerId;

    const leagues = JSON.parse(localStorage.getItem('fsl_leagues') || '[]');
    leagues.push({ leagueId: String(data.leagueId), adminToken: data.adminToken, name, managerId: data.adminManagerId });
    localStorage.setItem('fsl_leagues', JSON.stringify(leagues));

    saveState();  

    showSuccess('create-success', `League created! Loading admin panel...`);
    setTimeout(() => enterLeague(), 1000);
  } catch(e) {
    showError('create-error', 'Failed to create league. Is the server running?');
  }
}

async function joinWithToken() {
  const input = document.getElementById('join-token').value.trim();
  showError('join-error', '');

  // Extract token from URL or use directly
  let token = input;
  if (input.includes('token=')) {
    token = new URL(input).searchParams.get('token');
  } else if (input.includes('admin=')) {
    token = new URL(input).searchParams.get('admin');
    // This is an admin rejoin
  }

  // Check URL params first
  const params = new URLSearchParams(window.location.search);
  const urlToken = params.get('token') || params.get('admin') || token;
  const urlLeague = params.get('league') || state.leagueId;

  if (!urlLeague) return showError('join-error', 'Please enter your invite link.');

  state.leagueId = urlLeague;

  try {
    const res = await fetch(`${API}/api/leagues/${urlLeague}/admin`, {
      headers: { 'x-admin-token': urlToken }
    });

    if (res.ok) {
      // This is an admin token
      state.adminToken = urlToken;
      state.isAdmin = true;
      saveState();
      enterLeague();
      return;
    }
  } catch(e) {}

  // Try as manager invite: resolve token (already joined → re-enter; else show setup)
  try {
    const slotRes = await fetch(`${API}/api/leagues/${urlLeague}/slot-by-token?token=${encodeURIComponent(urlToken)}`);
    const slotData = await slotRes.json().catch(() => ({}));
    if (slotRes.ok && slotData.managerId) {
      state.managerId = slotData.managerId;
      state.managerName = slotData.managerName || '';
      saveState();
      enterLeague();
      return;
    }
    if (slotRes.ok && slotData.pending) {
      const leagueRes = await fetch(`${API}/api/leagues/${urlLeague}`);
      if (!leagueRes.ok) return showError('join-error', 'League not found.');
      const league = await leagueRes.json();
      state.pendingToken = urlToken;
      state.leagueId = urlLeague;
      document.getElementById('join-league-name').textContent = league.name;
      document.getElementById('join-league-sub').textContent = `${league.competition?.name || ''} · ${league.managerCount} managers`;
      showPage('join');
      return;
    }
    showError('join-error', (slotData.error) || 'Invalid link. Please check and try again.');
  } catch(e) {
    showError('join-error', 'Invalid link. Please check and try again.');
  }
}

async function completeJoin() {
  const managerName = document.getElementById('setup-manager-name').value.trim();
  const teamName = document.getElementById('setup-team-name').value.trim();
  showError('setup-error', '');

  if (!managerName || !teamName) return showError('setup-error', 'Please fill in both fields.');

  try {
    const res = await fetch(`${API}/api/leagues/${state.leagueId}/join`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: state.pendingToken, managerName, teamName })
    });
    const data = await res.json();
    if (!res.ok) return showError('setup-error', data.error);

    state.managerId = data.managerId;
    state.managerName = data.managerName;
    saveState();
    enterLeague();
  } catch(e) {
    showError('setup-error', 'Failed to join. Please try again.');
  }
}

async function enterLeague() {
  if (!state.leagueId) return;

  try {
    const headers = {};
    if (state.adminToken) headers['x-admin-token'] = state.adminToken;

    const leagueRes = await fetch(`${API}/api/leagues/${state.leagueId}${state.isAdmin ? '/admin' : ''}`, { headers });
    if (!leagueRes.ok) return;
    state.league = await leagueRes.json();

    // Update nav
    document.getElementById('nav-league-name').textContent = state.league.name;
    if (state.isAdmin) document.getElementById('nav-admin-badge').style.display = 'inline';

    // Show tabs
    document.getElementById('tab-home').classList.remove('hidden');
    document.getElementById('tab-draft').classList.remove('hidden');
    document.getElementById('tab-pool').classList.remove('hidden');
    if (state.isAdmin) document.getElementById('tab-admin').classList.remove('hidden');

    // Load players
    if (state.players.length === 0) await loadPlayers();

    // Go to home
    showPage('home');
    document.getElementById('tab-home').classList.add('active');
    renderHome();

    if (state.isAdmin) setupAdminPage();
  } catch(e) {
    console.error('Failed to enter league', e);
  }
}

// =============================================
// PLAYER DATA
// =============================================
async function loadPlayers() {
  if (!state.league) return;
  if (state.loadingPlayers) return;
  state.loadingPlayers = true;
  showError('global-error', '');
  // Use cached players if available
  const cached = localStorage.getItem('fsl_players');
  const cachedTeams = localStorage.getItem('fsl_teams');
  if (cached && cachedTeams) {
    state.players = JSON.parse(cached);
    state.teams = JSON.parse(cachedTeams);
    applyDraftPicks();
    populateCountryFilters();
    populateManualPlayerSelect();
    state.loadingPlayers = false;
    return;
  }
  const { leagueId, season } = state.league.competition;

  try {
    // Load teams
    const UCL_16 = [
  { id: 40,  name: 'Liverpool',         code: 'LIV' },
  { id: 42,  name: 'Arsenal',           code: 'ARS' },
  { id: 50,  name: 'Manchester City',   code: 'MAN' },
  { id: 529, name: 'Barcelona',         code: 'BAR' },
  { id: 541, name: 'Real Madrid',       code: 'REA' },
  { id: 530, name: 'Atletico Madrid',   code: 'ATL' },
  { id: 157, name: 'Bayern Munich',     code: 'BAY' },
  { id: 85,  name: 'PSG',              code: 'PAR' },
  { id: 168, name: 'Bayer Leverkusen', code: 'BAY' },
  { id: 499, name: 'Atalanta',         code: 'ATA' },
  { id: 228, name: 'Sporting CP',      code: 'SPO' },
  { id: 49,  name: 'Chelsea',          code: 'CHE' },
  { id: 47,  name: 'Tottenham',        code: 'TOT' },
  { id: 34,  name: 'Newcastle',        code: 'NEW' },
  { id: 645, name: 'Galatasaray',      code: 'GAL' },
  { id: 327, name: 'Bodo/Glimt',       code: 'BOD' },
];

state.teams = UCL_16.map(t => ({
  id: `team-${t.id}`,
  apiId: t.id,
  name: `${t.name} Defense`,
  country: t.code,
  pos: 'TEAM',
  scores: {},
  draftedBy: null
}));

const playerMap = new Map();
const squadResults = [];
let firstSquadError = null;
for (const t of UCL_16) {
  try {
    console.log('Fetching:', t.name, t.id);
    const r = await fetch(`${API}/api/football/players/squads?team=${t.id}`);
    if (!r.ok) {
      let errBody = null;
      try { errBody = await r.json(); } catch(_) {}
      const msg = (errBody && errBody.error) ? errBody.error : `HTTP ${r.status}`;
      throw new Error(msg);
    }
    const data = await r.json();
    if (data && data.errors && Object.keys(data.errors).length > 0) {
      throw new Error(`API error: ${JSON.stringify(data.errors)}`);
    }
    console.log('Got:', t.name, (data.response||[]).length > 0 ? 'OK' : 'EMPTY');
    squadResults.push(data);
  } catch(e) {
    console.log('FAILED:', t.name, e.message);
    if (!firstSquadError) firstSquadError = `Some teams failed to load (likely API rate limit). Try again in ~60s. (${t.name}: ${e.message})`;
    squadResults.push({ response: [] });
  }
  await new Promise(resolve => setTimeout(resolve, 500));
}
    squadResults.forEach(data => {
      (data.response || []).forEach(squad => {
        (squad.players || []).forEach(p => {
          if (!playerMap.has(p.id)) {
            playerMap.set(p.id, {
              id: p.id,
              name: p.name,
              country: squad.team.code || squad.team.name.substring(0,3).toUpperCase(),
              pos: mapPosition(p.position),
              scores: {},
              draftedBy: null
            });
          }
        });
      });
    });

    state.players = Array.from(playerMap.values());
    console.log('Players loaded:', state.players.length);
    // Cache players locally so we don't hit API again
    localStorage.setItem('fsl_players', JSON.stringify(state.players));
    localStorage.setItem('fsl_teams', JSON.stringify(state.teams));
    state.loadingPlayers = false;

    applyDraftPicks();
    populateCountryFilters();
    populateManualPlayerSelect();

    if (firstSquadError) showError('global-error', firstSquadError);

  } catch(e) {
    console.error('Failed to load players', e);
    showError('global-error', `Failed to load players: ${e.message}`);
    state.loadingPlayers = false;
  }
}

function mapPosition(pos) {
  if (!pos) return 'MF';
  const p = pos.toLowerCase();
  if (p.includes('attack') || p.includes('forward')) return 'FW';
  if (p.includes('midfield')) return 'MF';
  if (p.includes('defend')) return 'DF';
  if (p.includes('goal')) return 'GK';
  return 'MF';
}

function applyDraftPicks() {
  if (!state.league) return;
  const allPlayers = [...state.players, ...state.teams];

  // Reset
  allPlayers.forEach(p => { p.draftedBy = null; p.draftRound = null; p.draftOverall = null; });

  state.league.draftPicks.forEach(pick => {
    const player = allPlayers.find(p => String(p.id) === String(pick.playerId));
    if (player) {
      player.draftedBy = pick.managerId;
      player.draftRound = pick.round;
      player.draftOverall = pick.overall;
    }
  });
}

function getAllPlayers() {
  return [...state.players, ...state.teams];
}

// =============================================
// SCORING
// =============================================
function getPlayerTotal(player) {
  let total = Object.values(player.scores || {}).reduce((a,b) => a+b, 0);
  // Add manual stats
  const manual = state.manualStats.filter(s => String(s.playerId) === String(player.id));
  manual.forEach(s => { total += s.value; });
  return total;
}

function getManagerTotal(managerId) {
  return getAllPlayers()
    .filter(p => p.draftedBy === managerId)
    .reduce((sum, p) => sum + getPlayerTotal(p), 0);
}

function getManagerPlayers(managerId) {
  const all = getAllPlayers().filter(p => p.draftedBy === managerId);
  const offense = all.filter(p => p.pos !== 'TEAM');
  const defense = all.find(p => p.pos === 'TEAM');
  return { offense, defense };
}

function formatScore(val) {
  if (val === undefined || val === null) return '';
  if (val === 0) return '0';
  return val > 0 ? '+'+val : String(val);
}

function scoreClass(val) {
  if (val === undefined || val === null) return '';
  if (val === 0) return 'zero';
  return val > 0 ? 'pos' : 'neg';
}

// =============================================
// HOME PAGE
// =============================================
function renderHome() {
  if (!state.league) return;
  const managers = state.league.managers || [];

  // Standings
  const sorted = [...managers].sort((a,b) => getManagerTotal(b.managerId) - getManagerTotal(a.managerId));
  const standingsList = document.getElementById('standings-list');
  standingsList.innerHTML = '';

  sorted.forEach((m, i) => {
    const pts = getManagerTotal(m.managerId);
    const rankClass = i===0?'gold':i===1?'silver':i===2?'bronze':'';
    standingsList.innerHTML += `
      <div class="standings-row">
        <div class="rank ${rankClass}">${i+1}</div>
        <div class="standings-name">${m.managerName}</div>
        <div class="standings-pts">${pts}</div>
      </div>`;
  });

  const undraftedPts = getAllPlayers().filter(p => !p.draftedBy).reduce((s,p)=>s+getPlayerTotal(p),0);
  standingsList.innerHTML += `
    <div class="standings-row undrafted-row">
      <div class="rank">—</div>
      <div class="standings-name">Undrafted</div>
      <div class="standings-pts">${undraftedPts}</div>
    </div>`;

  // Manager blocks
  const col = document.getElementById('managers-column');
  col.innerHTML = '';

  const stageHeaders = STAGES.map(s=>`<span>${s}</span>`).join('');
  const gridCols = `180px 60px ${STAGES.map(()=>'42px').join(' ')} 70px`;

  managers.forEach((m, mi) => {
    const { offense, defense } = getManagerPlayers(m.managerId);
    const total = getManagerTotal(m.managerId);

    const playerRows = offense.map(p => {
      const cells = STAGES.map(s => {
        const v = p.scores[s];
        return `<span class="md-cell ${v !== undefined ? scoreClass(v) : ''}">${v !== undefined ? formatScore(v) : ''}</span>`;
      }).join('');
      return `<div class="player-row" style="grid-template-columns:${gridCols}">
        <span class="player-name">${p.name}</span>
        <span class="player-country">${p.country}</span>
        ${cells}
        <span class="total-cell">${getPlayerTotal(p)}</span>
      </div>`;
    }).join('');

    let defRow = '';
    if (defense) {
      const cells = STAGES.map(s => {
        const v = defense.scores[s];
        return `<span class="md-cell ${v !== undefined ? scoreClass(v) : ''}">${v !== undefined ? formatScore(v) : ''}</span>`;
      }).join('');
      defRow = `<div class="player-row defense-row" style="grid-template-columns:${gridCols}">
        <span class="player-name">${defense.name}</span>
        <span class="player-country">${defense.country}</span>
        ${cells}
        <span class="total-cell">${getPlayerTotal(defense)}</span>
      </div>`;
    } else {
      defRow = `<div class="player-row defense-row" style="grid-template-columns:${gridCols}">
        <span class="player-name" style="color:var(--gray);font-style:italic">No defense drafted</span>
        <span></span>${STAGES.map(()=>'<span></span>').join('')}<span></span>
      </div>`;
    }

    col.innerHTML += `
      <div class="manager-block">
        <div class="manager-header mc-${mi % 8}" style="border-left:3px solid transparent">
          <span class="manager-name-cell">${m.managerName}</span>
          <span class="manager-team-cell">— ${m.teamName || ''}</span>
        </div>
        <div class="col-header" style="grid-template-columns:${gridCols}">
          <span>Player</span><span style="font-size:10px;color:var(--gray)">Ctry</span>
          ${stageHeaders}
          <span style="text-align:right">Total</span>
        </div>
        ${playerRows}
        ${defRow}
        <div class="manager-total-row">
          <span class="manager-total-label">Team Total</span>
          <span class="manager-total-pts">${total} pts</span>
        </div>
      </div>`;
  });

  if (managers.length === 0) {
    col.innerHTML = '<div class="empty-state">No managers have joined yet. Share your invite links!</div>';
  }
}

// =============================================
// DRAFT PAGE
// =============================================
function renderDraft() {
  if (!state.league) return;
  const league = state.league;
  const draftOrder = league.draftOrder || [];
  const picks = league.draftPicks || [];
  const rounds = ROSTER_SLOTS;
  const snakePicks = generateSnakePicks(draftOrder, rounds);
  const currentPick = snakePicks[picks.length] || null;

  // On clock banner
  if (currentPick) {
    document.getElementById('on-clock-name').textContent = currentPick.managerName;
    document.getElementById('on-clock-round').textContent = currentPick.round;
    document.getElementById('on-clock-overall').textContent = currentPick.overall;
    document.getElementById('clock-banner').style.display = 'flex';
  } else {
    document.getElementById('clock-banner').style.display = 'none';
  }

  // Snake scroll
  const scroll = document.getElementById('snake-scroll');
  scroll.innerHTML = '';
  snakePicks.forEach((p, i) => {
    const pick = picks[i];
    const player = pick ? getAllPlayers().find(pl => String(pl.id) === String(pick.playerId)) : null;
    const isCompleted = !!pick;
    const isCurrent = currentPick && p.overall === currentPick.overall;
    scroll.innerHTML += `
      <div class="snake-pick ${isCompleted?'completed':''} ${isCurrent?'current':''}">
        <div class="snake-pick-num">R${p.round} · #${p.overall}</div>
        <div class="snake-pick-manager">${p.managerName}</div>
        ${isCompleted && player ? `<div class="snake-pick-player">${player.name} · ${player.country}</div>` : ''}
      </div>`;
  });

  setTimeout(() => {
    const cur = scroll.querySelector('.current');
    if (cur) cur.scrollIntoView({ behavior:'smooth', inline:'center', block:'nearest' });
  }, 100);

  // Roster selector
  const sel = document.getElementById('roster-selector');
  const managers = league.managers || [];
  sel.innerHTML = managers.map(m => `<option value="${m.managerId}">${m.managerName} — ${m.teamName}</option>`).join('');

  // Default to current manager's team
  if (state.managerId) {
    const myManager = managers.find(m => m.managerId === state.managerId);
    if (myManager) sel.value = state.managerId;
  }

  renderRoster();
  filterDraftPool();
  renderDraftResults();
}

function renderRoster() {
  if (!state.league) return;
  const managerId = document.getElementById('roster-selector').value;
  const { offense, defense } = getManagerPlayers(managerId);
  const container = document.getElementById('roster-display');
  container.innerHTML = '';

  for (let i = 0; i < 7; i++) {
    const p = offense[i];
    if (p) {
      container.innerHTML += `
        <div class="roster-slot">
          <div>
            <div class="slot-label">Round ${p.draftRound}</div>
            <div class="slot-name">${p.name}</div>
            <div class="slot-country">${p.country} · ${p.pos}</div>
          </div>
          <div class="slot-pick-info">${p.draftRound}(${p.draftOverall})</div>
        </div>`;
    } else {
      container.innerHTML += `
        <div class="roster-slot">
          <div>
            <div class="slot-label">Slot ${i+1}</div>
            <div class="slot-name empty">Empty</div>
          </div>
        </div>`;
    }
  }

  if (defense) {
    container.innerHTML += `
      <div class="roster-slot defense">
        <div>
          <div class="slot-label">Defense · Round ${defense.draftRound}</div>
          <div class="slot-name">${defense.name}</div>
          <div class="slot-country">${defense.country}</div>
        </div>
        <div class="slot-pick-info">${defense.draftRound}(${defense.draftOverall})</div>
      </div>`;
  } else {
    container.innerHTML += `
      <div class="roster-slot defense">
        <div>
          <div class="slot-label">Defense</div>
          <div class="slot-name empty">Empty</div>
        </div>
      </div>`;
  }
}

function filterDraftPool() {
  const search = document.getElementById('draft-search').value.toLowerCase();
  const posFilter = document.getElementById('draft-pos-filter').value;
  const countryFilter = document.getElementById('draft-country-filter').value;
  const league = state.league;
  const picks = league ? league.draftPicks : [];
  const draftedIds = new Set(picks.map(p => String(p.playerId)));

  const available = getAllPlayers().filter(p => {
    if (draftedIds.has(String(p.id))) return false;
    if (posFilter && p.pos !== posFilter) return false;
    if (countryFilter && p.country !== countryFilter) return false;
    if (search && !p.name.toLowerCase().includes(search) && !p.country.toLowerCase().includes(search)) return false;
    return true;
  });

  document.getElementById('available-count').textContent = available.length + ' left';

  const container = document.getElementById('draft-pool');
  if (available.length === 0) {
    container.innerHTML = '<div class="empty-state">No players match your filters</div>';
    return;
  }

  // Determine if it's this manager's turn
  const snakePicks = generateSnakePicks(league?.draftOrder || [], ROSTER_SLOTS);
  const currentPick = snakePicks[picks.length];
  const isMyTurn = state.isAdmin || (currentPick && currentPick.managerId === state.managerId);

  container.innerHTML = available.map(p => `
    <div class="pool-player ${state.selectedPlayer?.id === p.id ? 'selected' : ''} ${!isMyTurn ? 'not-your-turn' : ''}"
         onclick="${isMyTurn ? `selectPlayer('${p.id}')` : ''}">
      <div>
        <div class="pool-player-name">${p.name}</div>
        <div class="pool-player-meta">
          <span class="pool-player-country">${p.country}</span>
          <span class="pool-player-pos pos-${p.pos.toLowerCase()}">${p.pos}</span>
        </div>
      </div>
    </div>`).join('');
}

function selectPlayer(id) {
  const player = getAllPlayers().find(p => String(p.id) === String(id));
  if (!player) return;
  state.selectedPlayer = player;
  const bar = document.getElementById('confirm-bar');
  bar.classList.remove('hidden');
  document.getElementById('confirm-player-name').textContent = player.name;

  const league = state.league;
  const snakePicks = generateSnakePicks(league?.draftOrder || [], ROSTER_SLOTS);
  const currentPick = snakePicks[(league?.draftPicks||[]).length];
  document.getElementById('confirm-player-sub').textContent =
    `${player.country} · ${player.pos} — Draft for ${currentPick?.managerName || '?'}?`;

  filterDraftPool();
}

function clearSelection() {
  state.selectedPlayer = null;
  document.getElementById('confirm-bar').classList.add('hidden');
  filterDraftPool();
}

async function confirmPick() {
  if (!state.selectedPlayer || !state.league) return;
  const league = state.league;
  const snakePicks = generateSnakePicks(league.draftOrder || [], ROSTER_SLOTS);
  const currentPick = snakePicks[league.draftPicks.length];
  if (!currentPick) return;

  try {
    const headers = { 'Content-Type': 'application/json' };
    if (state.adminToken) headers['x-admin-token'] = state.adminToken;

    const res = await fetch(`${API}/api/leagues/${state.leagueId}/pick`, {
      method: 'POST',
      headers,
      body: JSON.stringify({
        managerId: state.managerId || currentPick.managerId,
        playerId: String(state.selectedPlayer.id),
        adminOverride: state.isAdmin
      })
    });

    const data = await res.json();
    if (!res.ok) return alert(data.error);

    // Update local state
    league.draftPicks.push(data.pick);
    applyDraftPicks();
    state.selectedPlayer = null;
    document.getElementById('confirm-bar').classList.add('hidden');
    renderDraft();
    renderHome();
  } catch(e) {
    alert('Failed to submit pick. Please try again.');
  }
}

function renderDraftResults() {
  const container = document.getElementById('draft-results');
  const picks = state.league?.draftPicks || [];

  if (picks.length === 0) {
    container.innerHTML = '<div class="empty-state">No picks yet</div>';
    return;
  }

  const reversed = [...picks].reverse();
  container.innerHTML = reversed.map(pick => {
    const player = getAllPlayers().find(p => String(p.id) === String(pick.playerId));
    return `
      <div class="result-item">
        <div class="result-pick-num">
          <div class="result-round">Rd ${pick.round}</div>
          <div>#${pick.overall}</div>
        </div>
        <div>
          <div class="result-player">${player ? player.name : pick.playerId}
            <span class="result-country">${player?.country || ''}</span>
          </div>
          <div class="result-manager">${pick.managerName}</div>
        </div>
      </div>`;
  }).join('');
}

// =============================================
// PLAYER POOL PAGE
// =============================================
function renderPoolPage(filtered) {
  const players = filtered !== undefined ? filtered : getAllPlayers();
  const body = document.getElementById('pool-table-body');
  const picks = state.league?.draftPicks || [];
  const draftedIds = new Set(picks.map(p => String(p.playerId)));

  if (players.length === 0) {
    body.innerHTML = '<div class="empty-state">No players match</div>';
    return;
  }

  body.innerHTML = players.map(p => {
    const drafted = draftedIds.has(String(p.id));
    const manager = drafted ? state.league?.managers?.find(m => m.managerId === p.draftedBy) : null;
    const total = getPlayerTotal(p);
    const stageCells = STAGES.map(s => {
      const v = p.scores[s];
      return `<span>${v !== undefined ? formatScore(v) : ''}</span>`;
    }).join('');
    return `
      <div class="pool-table-row ${drafted ? 'drafted' : ''}">
        <span>${p.name}${drafted ? '<span class="tag-drafted">drafted</span>' : ''}</span>
        <span>${p.country}</span>
        <span><span class="pool-player-pos pos-${p.pos.toLowerCase()}">${p.pos}</span></span>
        ${stageCells}
        <span>${drafted ? (manager?.managerName || '—') : (total > 0 ? total+' pts' : 'Available')}</span>
      </div>`;
  }).join('');
}

function filterPoolPage() {
  const search = document.getElementById('pool-search').value.toLowerCase();
  const pos = document.getElementById('pool-pos-filter').value;
  const country = document.getElementById('pool-country-filter').value;
  const status = document.getElementById('pool-status-filter').value;
  const picks = state.league?.draftPicks || [];
  const draftedIds = new Set(picks.map(p => String(p.playerId)));

  const filtered = getAllPlayers().filter(p => {
    if (pos && p.pos !== pos) return false;
    if (country && p.country !== country) return false;
    if (status === 'available' && draftedIds.has(String(p.id))) return false;
    if (status === 'drafted' && !draftedIds.has(String(p.id))) return false;
    if (search && !p.name.toLowerCase().includes(search) && !p.country.toLowerCase().includes(search)) return false;
    return true;
  });
  renderPoolPage(filtered);
}

// =============================================
// ADMIN PAGE
// =============================================
function setupAdminPage() {
  if (!state.league) return;
  const league = state.league;

  document.getElementById('admin-league-info').textContent =
    `${league.name} · ${league.competition?.name} · ${league.managerCount} managers`;

  // Admin link
  document.getElementById('admin-link-display').textContent =
    `${window.location.origin}?league=${state.leagueId}&admin=${state.adminToken}`;

  // Invite links
  const grid = document.getElementById('invite-links-grid');
  grid.innerHTML = '';
  (league.inviteLinks || []).forEach(link => {
    const joined = !!link.managerId;
    const url = `${window.location.origin}?league=${state.leagueId}&token=${link.token}`;
    grid.innerHTML += `
      <div class="invite-link-row">
        <div class="invite-slot-label">Slot ${link.slot}</div>
        <div class="invite-link-text">${joined ? (link.managerName + ' — ' + link.teamName) : url}</div>
        <div>
          ${joined ? `<span class="invite-status status-joined">✓ Joined</span>` : ''}
          <button class="btn btn-outline btn-sm" onclick="copyLink('${url}')">Copy Link</button>
        </div>
      </div>`;
  });

  // Draft order
  renderDraftOrderAdmin();
  populateManualPlayerSelect();
}

function renderDraftOrderAdmin() {
  const league = state.league;
  const managers = league?.managers || [];
  const order = state.draftOrder.length > 0 ? state.draftOrder : managers.map(m => m.managerId);
  state.draftOrder = order;

  const list = document.getElementById('draft-order-list');
  list.innerHTML = '';
  order.forEach((managerId, i) => {
    const manager = managers.find(m => m.managerId === managerId);
    list.innerHTML += `
      <div class="draft-order-item">
        <div class="order-num">${i+1}</div>
        <div class="order-name">${manager?.managerName || managerId} <span style="color:var(--gray);font-size:11px">— ${manager?.teamName || ''}</span></div>
        <div style="display:flex;gap:4px">
          ${i > 0 ? `<button class="btn btn-outline btn-sm" style="padding:4px 8px" onclick="moveDraftOrder(${i}, ${i-1})">↑</button>` : ''}
          ${i < order.length-1 ? `<button class="btn btn-outline btn-sm" style="padding:4px 8px" onclick="moveDraftOrder(${i}, ${i+1})">↓</button>` : ''}
        </div>
      </div>`;
  });
}

function moveDraftOrder(from, to) {
  const arr = [...state.draftOrder];
  const item = arr.splice(from, 1)[0];
  arr.splice(to, 0, item);
  state.draftOrder = arr;
  renderDraftOrderAdmin();
}

function randomizeDraftOrder() {
  const arr = [...state.draftOrder];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  state.draftOrder = arr;
  renderDraftOrderAdmin();
}

async function saveDraftOrder() {
  const managers = state.league?.managers || [];
  const order = state.draftOrder.map(id => {
    const m = managers.find(m => m.managerId === id);
    return { id: m.managerId, name: m.managerName };
  });

  try {
    const res = await fetch(`${API}/api/leagues/${state.leagueId}/draft-order`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-admin-token': state.adminToken },
      body: JSON.stringify({ order })
    });
    if (res.ok) {
      state.league.draftOrder = order;
      showMsg('draft-control-msg', 'Draft order saved!');
    }
  } catch(e) { alert('Failed to save draft order.'); }
}

async function toggleDraft(open) {
  try {
    const res = await fetch(`${API}/api/leagues/${state.leagueId}/draft-status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-admin-token': state.adminToken },
      body: JSON.stringify({ open })
    });
    if (res.ok) {
      state.league.draftOpen = open;
      showMsg('draft-control-msg', open ? 'Draft is now OPEN!' : 'Draft closed.');
    }
  } catch(e) { alert('Failed to update draft status.'); }
}

async function undoLastPick() {
  if (!confirm('Undo the last pick?')) return;
  try {
    const res = await fetch(`${API}/api/leagues/${state.leagueId}/pick`, {
      method: 'DELETE',
      headers: { 'x-admin-token': state.adminToken }
    });
    const data = await res.json();
    if (res.ok) {
      state.league.draftPicks.pop();
      applyDraftPicks();
      showMsg('draft-control-msg', `Undid pick: ${data.undone?.managerName}`);
      renderDraft();
      renderHome();
    }
  } catch(e) { alert('Failed to undo pick.'); }
}

function populateManualPlayerSelect() {
  const sel = document.getElementById('manual-player');
  if (!sel) return;
  const all = getAllPlayers().sort((a,b) => a.name.localeCompare(b.name));
  sel.innerHTML = all.map(p => `<option value="${p.id}">${p.name} (${p.country})</option>`).join('');
}

async function addManualStat() {
  const playerId = document.getElementById('manual-player').value;
  const stage = document.getElementById('manual-stage').value;
  const statType = document.getElementById('manual-stat-type').value;

  const pointsMap = {
    penalty_drawn: 1, goal: 3, pk_goal: 2, assist: 1, pk_miss: -1, red_card: -2
  };
  const value = pointsMap[statType];

  try {
    const res = await fetch(`${API}/api/leagues/${state.leagueId}/manual-stat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-admin-token': state.adminToken },
      body: JSON.stringify({ playerId, stage, statType, value, note: statType })
    });

    if (res.ok) {
      const player = getAllPlayers().find(p => String(p.id) === String(playerId));
      state.manualStats.push({ playerId, stage, statType, value });

      // Update player scores
      if (player) {
        if (!player.scores[stage]) player.scores[stage] = 0;
        player.scores[stage] += value;
      }

      renderManualStatLog();
      renderHome();
    }
  } catch(e) { alert('Failed to add stat.'); }
}

function renderManualStatLog() {
  const log = document.getElementById('manual-stat-log');
  if (!log) return;
  if (state.manualStats.length === 0) { log.innerHTML = ''; return; }

  log.innerHTML = [...state.manualStats].reverse().map(s => {
    const player = getAllPlayers().find(p => String(p.id) === String(s.playerId));
    return `
      <div class="stat-log-item">
        <span>${player?.name || s.playerId} · ${s.stage}</span>
        <span style="font-size:11px;color:var(--gray)">${s.statType.replace('_',' ')}</span>
        <span class="stat-pts">${s.value > 0 ? '+' : ''}${s.value}</span>
      </div>`;
  }).join('');
}

// =============================================
// HELPERS
// =============================================
function generateSnakePicks(draftOrder, rounds) {
  const picks = [];
  if (!draftOrder || draftOrder.length === 0) return picks;
  for (let r = 0; r < rounds; r++) {
    const order = r % 2 === 0 ? [...draftOrder] : [...draftOrder].reverse();
    order.forEach((manager, i) => {
      picks.push({
        round: r+1,
        pickInRound: i+1,
        overall: r * draftOrder.length + i + 1,
        managerId: manager.id || manager,
        managerName: manager.name || manager
      });
    });
  }
  return picks;
}

function populateCountryFilters() {
  const countries = [...new Set(getAllPlayers().map(p => p.country))].sort();
  ['draft-country-filter', 'pool-country-filter'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    countries.forEach(c => {
      if (!Array.from(sel.options).find(o => o.value === c)) {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
      }
    });
  });
}

function copyLink(url) {
  navigator.clipboard.writeText(url).then(() => alert('Link copied!'));
}

function showError(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.style.display = msg ? 'block' : 'none';
}

function showSuccess(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.style.display = msg ? 'block' : 'none';
}

function showMsg(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 3000);
}

function goHome() {
  if (!confirm('Go to home screen? You can rejoin this league using your admin or invite link.')) return;
  localStorage.removeItem('fsl_state');
  localStorage.removeItem('fantasyLeagueState');
  window.location.href = window.location.origin;
}

function showPage(name, tabEl) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (tabEl) tabEl.classList.add('active');

  if (name === 'draft') renderDraft();
  if (name === 'pool') { renderPoolPage(); filterPoolPage(); }
  if (name === 'admin') setupAdminPage();
}

// =============================================
// AUTO-REFRESH
// =============================================
async function refreshLeague() {
  if (!state.leagueId) return;
  try {
    const headers = {};
    if (state.adminToken) headers['x-admin-token'] = state.adminToken;
    const res = await fetch(`${API}/api/leagues/${state.leagueId}${state.isAdmin ? '/admin' : ''}`, { headers });
    if (res.ok) {
      state.league = await res.json();
      applyDraftPicks();
    }
  } catch(e) {}
}

// Poll for updates every 30 seconds
setInterval(async () => {
  if (state.leagueId) {
    await refreshLeague();
    const activePage = document.querySelector('.page.active')?.id;
    if (activePage === 'page-home') renderHome();
    if (activePage === 'page-draft') renderDraft();
    if (activePage === 'page-pool') renderPoolPage();
  }
}, 30000);

// =============================================
// INIT
// =============================================
function renderMyLeagues() {
  const leagues = JSON.parse(localStorage.getItem('fsl_leagues') || '[]');
  if (leagues.length === 0) return;
  document.getElementById('my-leagues-section').style.display = 'block';
  const list = document.getElementById('my-leagues-list');
  list.innerHTML = leagues.map((l, i) => `
    <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:10px 14px;background:rgba(0,0,0,0.2);border:1px solid var(--card-border);border-radius:6px">
      <div>
        <div style="font-weight:600;font-size:14px">${l.name}</div>
        <div style="font-size:11px;color:var(--gray)">League #${l.leagueId}</div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="rejoinLeague(${i})">Enter</button>
    </div>
  `).join('');
}

function rejoinLeague(index) {
  const leagues = JSON.parse(localStorage.getItem('fsl_leagues') || '[]');
  const l = leagues[index];
  state.leagueId = l.leagueId;
  state.adminToken = l.adminToken;
  state.managerId = l.managerId;
  state.isAdmin = true;
  saveState();
  enterLeague();
}
loadState();
renderMyLeagues();

// Check URL params for auto-login
const urlParams = new URLSearchParams(window.location.search);
const urlLeague = urlParams.get('league');
const urlAdmin = urlParams.get('admin');
const urlToken = urlParams.get('token');

if (urlLeague && urlAdmin) {
  state.leagueId = urlLeague;
  state.adminToken = urlAdmin;
  state.isAdmin = true;
  saveState();
  enterLeague();
} else if (urlLeague && urlToken) {
  state.leagueId = urlLeague;
  state.pendingToken = urlToken;
  // Resolve token: already joined → re-enter league; otherwise show join form
  fetch(`${API}/api/leagues/${urlLeague}/slot-by-token?token=${encodeURIComponent(urlToken)}`)
    .then(r => r.json().then(data => ({ ok: r.ok, data })))
    .then(({ ok, data }) => {
      if (ok && data.managerId) {
        state.managerId = data.managerId;
        state.managerName = data.managerName || '';
        saveState();
        enterLeague();
        return;
      }
      if (ok && data.pending) {
        fetch(`${API}/api/leagues/${urlLeague}`)
          .then(r => r.json())
          .then(league => {
            document.getElementById('join-league-name').textContent = league.name;
            document.getElementById('join-league-sub').textContent = `${league.competition?.name || ''} · ${league.managerCount} managers`;
            showError('setup-error', '');
            showPage('join');
          });
        return;
      }
      fetch(`${API}/api/leagues/${urlLeague}`)
        .then(r => r.json())
        .then(league => {
          document.getElementById('join-league-name').textContent = league.name;
          document.getElementById('join-league-sub').textContent = `${league.competition?.name || ''} · ${league.managerCount} managers`;
          showError('setup-error', (data && data.error) ? data.error : 'Invalid invite link.');
          showPage('join');
        });
    })
    .catch(() => {
      fetch(`${API}/api/leagues/${urlLeague}`)
        .then(r => r.json())
        .then(league => {
          document.getElementById('join-league-name').textContent = league.name;
          document.getElementById('join-league-sub').textContent = `${league.competition?.name || ''} · ${league.managerCount} managers`;
          showPage('join');
        });
    });
} else if (state.leagueId && (state.adminToken || state.managerId)) {
  enterLeague();
}
</script>
</body>
</html>